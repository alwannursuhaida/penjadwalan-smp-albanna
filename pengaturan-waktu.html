<script type="module">
    import { db, ref, set, onValue } from './config.js';

    // Expose fungsi ke window agar bisa dipanggil HTML (onclick)
    window.generateSlots = generateSlots;
    window.recalculateChain = recalculateChain;
    window.updateRowStyle = updateRowStyle;
    window.simpanPengaturan = simpanPengaturan;

    // Load Data saat pertama buka
    onValue(ref(db, 'pengaturan'), (snapshot) => {
        const settings = snapshot.val();
        if (settings) {
            document.getElementById('jumlah-slot').value = settings.jumlahSlot;
            const container = document.getElementById('slot-container');
            container.innerHTML = '';
            settings.slots.forEach(slot => {
                createRow(slot.no, slot.start, slot.duration, slot.end, slot.type);
            });
        } else {
            generateSlots(); // Default jika kosong
        }
    });

    function generateSlots() {
        const jumlah = parseInt(document.getElementById('jumlah-slot').value);
        const durasi = parseInt(document.getElementById('durasi-default').value);
        const jamAwal = document.getElementById('jam-mulai-awal').value; 
        
        const container = document.getElementById('slot-container');
        container.innerHTML = '';
        let currentTime = new Date(`2000-01-01T${jamAwal}`);

        for (let i = 1; i <= jumlah; i++) {
            let endTime = new Date(currentTime.getTime() + durasi * 60000);
            createRow(i, formatTime(currentTime), durasi, formatTime(endTime), 'pelajaran');
            currentTime = endTime;
        }
    }

    function createRow(no, start, duration, end, type) {
        const container = document.getElementById('slot-container');
        const tr = document.createElement('tr');
        const bgClass = type === 'istirahat' ? 'bg-orange-50' : 'bg-white';
        const readOnlyClass = no === 1 ? '' : 'bg-gray-100 text-gray-500 cursor-not-allowed';

        tr.className = `border-b border-gray-200 transition ${bgClass}`;
        tr.innerHTML = `
            <td class="py-3 px-4 text-center font-bold text-gray-500">${no}</td>
            <td class="py-3 px-4 text-center">
                <input type="time" class="input-start border border-gray-300 rounded p-1 w-32 text-center ${readOnlyClass}" value="${start}" onchange="recalculateChain(this)">
            </td>
            <td class="py-3 px-4 text-center">
                <input type="number" class="input-duration border border-gray-300 rounded p-1 w-24 text-center font-bold text-blue-600" value="${duration}" onchange="recalculateChain(this)">
            </td>
            <td class="py-3 px-4 text-center">
                <input type="time" class="input-end border border-gray-300 rounded p-1 w-32 text-center bg-gray-50" value="${end}" readonly>
            </td>
            <td class="py-3 px-4 text-center">
                <select class="input-type border border-gray-300 rounded p-1 w-full" onchange="updateRowStyle(this)">
                    <option value="pelajaran" ${type === 'pelajaran' ? 'selected' : ''}>Pelajaran</option>
                    <option value="istirahat" ${type === 'istirahat' ? 'selected' : ''}>Istirahat</option>
                </select>
            </td>
        `;
        container.appendChild(tr);
    }

    function recalculateChain(input) {
        let currentRow = input.closest('tr');
        updateRowEndTime(currentRow);
        updateNextRows(currentRow);
    }

    function updateRowEndTime(row) {
        const startStr = row.querySelector('.input-start').value;
        const duration = parseInt(row.querySelector('.input-duration').value) || 0;
        if(startStr) {
            const startTime = new Date(`2000-01-01T${startStr}`);
            const endTime = new Date(startTime.getTime() + duration * 60000);
            row.querySelector('.input-end').value = formatTime(endTime);
        }
    }

    function updateNextRows(currentRow) {
        let nextRow = currentRow.nextElementSibling;
        if (!nextRow) return;
        const currentEnd = currentRow.querySelector('.input-end').value;
        const nextStartInput = nextRow.querySelector('.input-start');
        nextStartInput.value = currentEnd;
        updateRowEndTime(nextRow);
        updateNextRows(nextRow);
    }

    function updateRowStyle(select) {
        const row = select.closest('tr');
        row.className = select.value === 'istirahat' ? row.className.replace('bg-white', 'bg-orange-50') : row.className.replace('bg-orange-50', 'bg-white');
    }

    function formatTime(dateObj) {
        return `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}`;
    }

    function simpanPengaturan() {
        const rows = document.querySelectorAll('#slot-container tr');
        const dataSlot = [];
        rows.forEach((row, index) => {
            dataSlot.push({
                no: index + 1,
                start: row.querySelector('.input-start').value,
                duration: row.querySelector('.input-duration').value,
                end: row.querySelector('.input-end').value,
                type: row.querySelector('.input-type').value
            });
        });
        // SIMPAN KE FIREBASE
        set(ref(db, 'pengaturan'), {
            jumlahSlot: document.getElementById('jumlah-slot').value,
            slots: dataSlot
        }).then(() => alert('Pengaturan tersimpan di Cloud!'));
    }
</script>
