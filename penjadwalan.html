<script type="module">
    import { db, ref, set, remove, onValue } from './config.js';

    // --- VARIABLES ---
    const kelasList = ['7A', '7B', '7C', '7D', '7E', '7F', '8A', '8B', '8C', '8D', '8E', '8F', '9A', '9B', '9C', '9D', '9E'];
    const labSubjects = ['informatika', 'ipa', 'seni budaya', 'bahasa bali'];
    
    let mapelData = [];
    let guruData = [];
    let settingData = { slots: [] };
    let jadwalFix = {}; 
    let isDataLoaded = false; // Flag untuk memastikan tabel sudah dirender

    // --- GLOBAL FUNCTIONS EXPOSED TO WINDOW ---
    window.allowDrop = (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); };
    window.leaveDrop = (e) => { e.currentTarget.classList.remove('drag-over'); };
    
    window.drop = (e, hari, kelas, jam) => {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        const raw = e.dataTransfer.getData('text/plain');
        if(!raw) return;
        
        const mapel = JSON.parse(raw);
        const cellId = `${hari}-${kelas}-${jam}`;

        const conflict = validateMove(hari, kelas, jam, mapel.id, null);
        if(conflict.status) {
            alert(`PERINGATAN: ${conflict.msg}`);
            return;
        }

        set(ref(db, `jadwal/${cellId}`), {
            mapelId: mapel.id,
            guruId: null
        });
    };

    window.hapusJadwal = (cellId) => {
        if(confirm('Hapus jadwal ini?')) remove(ref(db, `jadwal/${cellId}`));
    };

    window.onGuruChange = (selectEl, cellId) => {
        const guruId = selectEl.value;
        const [hari, kelas, jam] = cellId.split('-');
        const currentData = jadwalFix[cellId];
        
        if(!currentData) return;

        const conflict = validateMove(hari, kelas, jam, currentData.mapelId, guruId);
        if(conflict.status) {
            alert(conflict.msg);
            // Kembalikan pilihan ke sebelumnya atau kosongkan jika perlu
            // selectEl.value = ""; 
            return; 
        }

        set(ref(db, `jadwal/${cellId}`), {
            mapelId: currentData.mapelId,
            guruId: guruId
        });
    };

    window.renderJadwalView = renderJadwalView;
    window.resetJadwal = () => {
        if(confirm('Hapus SEMUA jadwal di Cloud?')) remove(ref(db, 'jadwal'));
    }

    // --- LOAD DATA (REALTIME) ---
    onValue(ref(db, 'mapel'), (snapshot) => {
        const data = snapshot.val();
        mapelData = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
        renderSourceMapel();
        if(isDataLoaded) hydrateCells(); 
    });

    onValue(ref(db, 'guru'), (snapshot) => {
        const data = snapshot.val();
        guruData = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
        if(isDataLoaded) hydrateCells();
    });

    onValue(ref(db, 'pengaturan'), (snapshot) => {
        const data = snapshot.val();
        settingData = data || { slots: [] };
        // Saat pengaturan waktu masuk, kita render ulang tabelnya
        renderJadwalView(); 
    });

    onValue(ref(db, 'jadwal'), (snapshot) => {
        jadwalFix = snapshot.val() || {};
        // Jadwal masuk, isi tabel (hanya jika tabel sudah ada)
        if(isDataLoaded) hydrateCells(); 
    });

    // --- RENDERING FUNCTIONS ---
    function renderSourceMapel() {
        const container = document.getElementById('source-container');
        if(!container) return; // Safety check
        container.innerHTML = '';
        mapelData.forEach(m => {
            const div = document.createElement('div');
            div.className = "p-2 rounded shadow-sm border cursor-move text-white font-medium text-xs flex justify-between items-center hover:scale-105 transition transform";
            div.style.backgroundColor = m.warna;
            div.innerText = m.nama;
            div.setAttribute('draggable', 'true');
            div.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', JSON.stringify(m)); });
            container.appendChild(div);
        });
    }

    function renderJadwalView() {
        // Safety Check: Pastikan elemen ada
        const selectHari = document.getElementById('select-hari');
        const headerRow = document.getElementById('header-row');
        const tbody = document.getElementById('jadwal-body');
        
        if(!selectHari || !headerRow || !tbody) return; 

        const hari = selectHari.value;
        
        // Render Header
        let headerHTML = `<th class="p-3 border w-24 sticky-left corner-header text-center">WAKTU / KELAS</th>`;
        kelasList.forEach(kelas => {
            const angkatan = kelas[0];
            let bg = angkatan === '7' ? '#dbeafe' : (angkatan === '8' ? '#dcfce7' : '#f3e8ff');
            headerHTML += `<th class="p-2 border text-center min-w-[140px] sticky-top" style="background-color: ${bg}; color: #1f2937;"><span class="text-lg font-bold">${kelas}</span></th>`;
        });
        headerRow.innerHTML = headerHTML;

        // Render Rows
        tbody.innerHTML = '';
        if(settingData.slots) {
            settingData.slots.forEach(slot => {
                const tr = document.createElement('tr');
                const isIstirahat = slot.type === 'istirahat';
                const infoWaktu = `<td class="border p-2 text-center sticky-left font-bold text-gray-700 shadow-sm"><div class="text-xs text-gray-500 mb-1">${slot.start} - ${slot.end}</div><div class="bg-gray-200 rounded px-2 py-1 inline-block text-xs">JP ${slot.no}</div></td>`;

                if (isIstirahat) {
                    tr.innerHTML = infoWaktu + `<td colspan="${kelasList.length}" class="bg-orange-100 text-center font-bold text-orange-600 tracking-widest border border-orange-200">I S T I R A H A T</td>`;
                } else {
                    tr.innerHTML = infoWaktu;
                    kelasList.forEach(kelas => {
                        const cellId = `${hari}-${kelas}-${slot.no}`;
                        tr.innerHTML += `<td id="${cellId}" class="border p-1 relative h-28 align-top transition hover:bg-gray-50 bg-white" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="drop(event, '${hari}', '${kelas}', '${slot.no}')"></td>`;
                    });
                }
                tbody.appendChild(tr);
            });
        }
        
        isDataLoaded = true; // Tandai tabel sudah siap
        hydrateCells();
    }

    function hydrateCells() {
        // Safety Check Paling Penting (Fix Error Anda)
        const selectHari = document.getElementById('select-hari');
        if(!selectHari) return; // Jika elemen belum ada, stop.

        const hari = selectHari.value;

        // Bersihkan dulu semua cell pelajaran
        document.querySelectorAll('td[id]').forEach(td => { td.innerHTML = ''; td.classList.remove('conflict'); });

        // Isi data
        Object.keys(jadwalFix).forEach(cellId => {
            if(cellId.startsWith(hari)) {
                const data = jadwalFix[cellId];
                // Cek apakah elemen TD nya ada (karena mungkin pengaturan waktu berubah)
                if(document.getElementById(cellId)) {
                    renderCellContent(cellId, data.mapelId, data.guruId);
                    
                    const [h, k, j] = cellId.split('-');
                    const res = validateMove(h, k, j, data.mapelId, data.guruId);
                    if(res.status) document.getElementById(cellId).classList.add('conflict');
                }
            }
        });
    }

    function renderCellContent(cellId, mapelId, currentGuruId) {
        const cell = document.getElementById(cellId);
        if(!cell) return; // Safety

        const mapel = mapelData.find(m => m.id === mapelId);
        if(!mapel) return;

        const currentGuruObj = guruData.find(g => g.id === currentGuruId);
        const inisialGuru = currentGuruObj ? currentGuruObj.kode : '?';

        let options = `<option value="">-- Pilih Guru --</option>`;
        guruData.forEach(g => {
            const sel = (g.id === currentGuruId) ? 'selected' : '';
            options += `<option value="${g.id}" ${sel}>${g.nama}</option>`;
        });

        cell.innerHTML = `
            <div class="h-full w-full rounded p-1 shadow-sm flex flex-col justify-between" style="background-color: ${mapel.warna}20; border-top: 3px solid ${mapel.warna};">
                <div class="flex justify-between items-start mb-1">
                    <span class="font-bold text-gray-800 text-[10px] leading-tight line-clamp-2" title="${mapel.nama}">${mapel.nama}</span>
                    <button onclick="hapusJadwal('${cellId}')" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex-1 flex items-center justify-center">
                    <div class="text-xl font-bold text-gray-600 tracking-wider bg-white bg-opacity-50 px-2 rounded">${currentGuruId ? inisialGuru : '...'}</div>
                </div>
                <select onchange="onGuruChange(this, '${cellId}')" class="w-full border border-gray-300 rounded p-0.5 bg-white text-[10px] mt-1 cursor-pointer">${options}</select>
            </div>
        `;
    }

    // === VALIDASI (SAMA) ===
    function validateMove(day, currentClass, timeSlot, mapelId, guruId) {
        const currentMapelObj = mapelData.find(m => m.id === mapelId);
        const mapelName = currentMapelObj ? currentMapelObj.nama.toLowerCase() : "";
        const currentAngkatan = currentClass.charAt(0);

        for (let otherClass of kelasList) {
            if (otherClass === currentClass) continue;
            
            const otherKey = `${day}-${otherClass}-${timeSlot}`;
            const otherData = jadwalFix[otherKey];

            if (otherData) {
                const otherMapelObj = mapelData.find(m => m.id === otherData.mapelId);
                const otherMapelName = otherMapelObj ? otherMapelObj.nama.toLowerCase() : "";
                const otherAngkatan = otherClass.charAt(0);

                if (guruId && otherData.guruId && guruId === otherData.guruId) 
                    return { status: true, msg: `Guru mengajar di ${otherClass}.` };

                const isRestricted = labSubjects.some(sub => mapelName.includes(sub));
                if (isRestricted && otherMapelName === mapelName) 
                    return { status: true, msg: `Lab dipakai ${otherClass}.` };

                const isPjok = mapelName.includes('pjok') || mapelName.includes('olahraga');
                const isOtherPjok = otherMapelName.includes('pjok') || otherMapelName.includes('olahraga');
                if (isPjok && isOtherPjok) {
                    if (currentAngkatan !== otherAngkatan) return { status: true, msg: `PJOK bentrok angkatan.` };
                    continue;
                }

                if (currentAngkatan === otherAngkatan && mapelName === otherMapelName) {
                    if (!mapelName.includes('doa')) return { status: true, msg: `Mapel sama di ${otherClass}.` };
                }
            }
        }
        return { status: false, msg: "Aman" };
    }
</script>
