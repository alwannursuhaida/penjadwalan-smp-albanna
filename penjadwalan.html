<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Susun Jadwal - EduSched</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .drag-over { background-color: #e0f2fe !important; border: 2px dashed #3b82f6; }
        .conflict { border: 2px solid red !important; background-color: #fee2e2 !important; }

        /* SCROLLBAR CUSTOM */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* STICKY HEADERS */
        th.sticky-top { position: sticky; top: 0; z-index: 20; box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1); }
        td.sticky-left, th.sticky-left { position: sticky; left: 0; z-index: 30; background-color: #f8fafc; border-right: 2px solid #e2e8f0; }
        th.corner-header { position: sticky; top: 0; left: 0; z-index: 40; background-color: #1e3a8a; color: white; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <header class="bg-blue-900 text-white p-3 flex justify-between items-center shadow-md flex-shrink-0">
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-blue-200 hover:text-white text-sm"><i class="fas fa-arrow-left"></i> Dashboard</a>
            <h1 class="text-lg font-bold border-l border-blue-700 pl-4">Penyusunan Jadwal</h1>
        </div>
        <div class="flex gap-2 items-center">
            <label class="font-semibold text-xs text-blue-200">Lihat Hari:</label>
            <select id="select-hari" onchange="renderJadwalView()" class="text-gray-800 rounded p-1 text-sm font-bold border-none outline-none focus:ring-2 focus:ring-blue-400">
                <option value="senin">Senin</option>
                <option value="selasa">Selasa</option>
                <option value="rabu">Rabu</option>
                <option value="kamis">Kamis</option>
                <option value="jumat">Jumat</option>
            </select>
            
            <button onclick="simpanJadwalFix()" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm font-bold shadow ml-2 transition">
                <i class="fas fa-save mr-1"></i> Simpan
            </button>
            <button onclick="resetJadwal()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm font-bold shadow transition">
                <i class="fas fa-trash"></i> Reset
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-56 bg-white border-r border-gray-200 flex flex-col shadow-lg z-10 flex-shrink-0">
            <div class="p-3 border-b bg-gray-50">
                <h3 class="font-bold text-gray-700 text-sm"><i class="fas fa-book mr-2"></i>Mapel</h3>
                <p class="text-[10px] text-gray-500">Drag mapel ke dalam grid.</p>
            </div>
            <div id="source-container" class="flex-1 overflow-y-auto p-2 space-y-2">
                </div>
            <div class="p-2 border-t bg-yellow-50 text-[10px] text-yellow-800 leading-tight">
                <b>Aturan Validasi:</b><br>
                1. Guru (Global Collision)<br>
                2. Lab (Info, IPA, dll)<br>
                3. PJOK (Beda Angkatan = Merah)<br>
                4. Angkatan (Mapel Sama = Merah)
            </div>
        </aside>

        <main class="flex-1 overflow-auto bg-gray-200 p-2 relative">
            <div class="bg-white rounded shadow border border-gray-300 inline-block">
                <table class="border-collapse text-sm whitespace-nowrap">
                    <thead>
                        <tr id="header-row">
                            </tr>
                    </thead>
                    <tbody id="jadwal-body">
                        </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        // === KONFIGURASI ===
        const kelasList = [
            '7A', '7B', '7C', '7D', '7E', '7F',
            '8A', '8B', '8C', '8D', '8E', '8F',
            '9A', '9B', '9C', '9D', '9E'
        ];
        
        // Mapel Khusus (Lab/Ruang Khusus)
        const labSubjects = ['informatika', 'ipa', 'seni budaya', 'bahasa bali'];
        
        let mapelData = [];
        let guruData = [];
        let settingData = {};
        let jadwalFix = {}; 

        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            renderSourceMapel();
            renderJadwalView();
        });

        function loadAllData() {
            mapelData = JSON.parse(localStorage.getItem('jadwal_mapel')) || [];
            guruData = JSON.parse(localStorage.getItem('jadwal_guru')) || [];
            settingData = JSON.parse(localStorage.getItem('jadwal_pengaturan')) || { slots: [] };
            jadwalFix = JSON.parse(localStorage.getItem('jadwal_fix')) || {};

            if(settingData.slots.length === 0) {
                alert("Silakan atur Jam Pelajaran dulu di menu Pengaturan Waktu!");
                window.location.href = 'pengaturan-waktu.html';
            }
        }

        // --- RENDER SIDEBAR ---
        function renderSourceMapel() {
            const container = document.getElementById('source-container');
            container.innerHTML = '';
            mapelData.forEach(m => {
                const div = document.createElement('div');
                div.className = "p-2 rounded shadow-sm border cursor-move text-white font-medium text-xs flex justify-between items-center hover:scale-105 transition transform";
                div.style.backgroundColor = m.warna;
                div.innerText = m.nama;
                div.setAttribute('draggable', 'true');
                div.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify(m));
                });
                container.appendChild(div);
            });
        }

        // --- RENDER MAIN TABLE ---
        function renderJadwalView() {
            const hari = document.getElementById('select-hari').value;
            const headerRow = document.getElementById('header-row');
            const tbody = document.getElementById('jadwal-body');

            // Header
            let headerHTML = `<th class="p-3 border w-24 sticky-left corner-header text-center">WAKTU / KELAS</th>`;
            kelasList.forEach(kelas => {
                const angkatan = kelas.substring(0, 1);
                let bgClass = '#dbeafe'; 
                if(angkatan === '8') bgClass = '#dcfce7'; 
                if(angkatan === '9') bgClass = '#f3e8ff'; 
                headerHTML += `<th class="p-2 border text-center min-w-[140px] sticky-top" style="background-color: ${bgClass}; color: #1f2937;"><span class="text-lg font-bold">${kelas}</span></th>`;
            });
            headerRow.innerHTML = headerHTML;

            // Rows
            tbody.innerHTML = '';
            settingData.slots.forEach(slot => {
                const tr = document.createElement('tr');
                const isIstirahat = slot.type === 'istirahat';
                const infoWaktu = `
                    <td class="border p-2 text-center sticky-left font-bold text-gray-700 shadow-sm" style="min-width: 100px;">
                        <div class="text-xs text-gray-500 mb-1">${slot.start} - ${slot.end}</div>
                        <div class="bg-gray-200 rounded px-2 py-1 inline-block text-xs">JP ${slot.no}</div>
                    </td>`;

                if (isIstirahat) {
                    tr.innerHTML = infoWaktu + `<td colspan="${kelasList.length}" class="bg-orange-100 text-center font-bold text-orange-600 tracking-widest border border-orange-200">I S T I R A H A T</td>`;
                } else {
                    tr.innerHTML = infoWaktu;
                    kelasList.forEach(kelas => {
                        const cellId = `${hari}-${kelas}-${slot.no}`;
                        tr.innerHTML += `<td id="${cellId}" class="border p-1 relative h-28 align-top transition hover:bg-gray-50 bg-white" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="drop(event, '${hari}', '${kelas}', '${slot.no}')"></td>`;
                    });
                }
                tbody.appendChild(tr);
            });
            hydrateCells(hari);
        }

        function hydrateCells(hari) {
            kelasList.forEach(kelas => {
                settingData.slots.forEach(slot => {
                    if (slot.type !== 'istirahat') {
                        const cellId = `${hari}-${kelas}-${slot.no}`;
                        const data = jadwalFix[cellId];
                        if (data) {
                            renderCellContent(cellId, data.mapelId, data.guruId);
                            checkAllConflicts(hari, kelas, slot.no, data.mapelId, data.guruId, cellId);
                        }
                    }
                });
            });
        }

        // --- DRAG & DROP UTILS ---
        function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function leaveDrop(e) { e.currentTarget.classList.remove('drag-over'); }

        function drop(e, hari, kelas, jam) {
            e.preventDefault();
            const cell = e.currentTarget;
            cell.classList.remove('drag-over');
            
            const raw = e.dataTransfer.getData('text/plain');
            if(!raw) return;
            const mapel = JSON.parse(raw);
            const cellId = cell.id;
            
            renderCellContent(cellId, mapel.id, null);
            updateJadwalMemory(cellId, mapel.id, null);

            const conflict = validateMove(hari, kelas, jam, mapel.id, null);
            if(conflict.status) {
                alert(`PERINGATAN: ${conflict.msg}`);
                cell.classList.add('conflict');
            } else {
                cell.classList.remove('conflict');
            }
        }

        // --- RENDER CELL CONTENT (MODIFIED) ---
        function renderCellContent(cellId, mapelId, currentGuruId) {
            const cell = document.getElementById(cellId);
            const mapel = mapelData.find(m => m.id == mapelId);
            if(!mapel) return;

            // Cari objek guru yang sedang dipilih untuk diambil INISIAL-nya
            const currentGuruObj = guruData.find(g => g.id == currentGuruId);
            const inisialGuru = currentGuruObj ? currentGuruObj.kode : '?';

            // Generate Options (Menggunakan Nama Lengkap)
            let options = `<option value="">-- Pilih Guru --</option>`;
            guruData.forEach(g => {
                const sel = (g.id == currentGuruId) ? 'selected' : '';
                options += `<option value="${g.id}" ${sel}>${g.nama}</option>`; // Nama Lengkap di dropdown
            });

            cell.innerHTML = `
                <div class="h-full w-full rounded p-1 shadow-sm flex flex-col justify-between" style="background-color: ${mapel.warna}20; border-top: 3px solid ${mapel.warna};">
                    
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-gray-800 text-[10px] leading-tight line-clamp-2" title="${mapel.nama}">${mapel.nama}</span>
                        <button onclick="hapusJadwal('${cellId}')" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
                    </div>

                    <div class="flex-1 flex items-center justify-center">
                        <div class="text-xl font-bold text-gray-600 tracking-wider bg-white bg-opacity-50 px-2 rounded">
                            ${currentGuruId ? inisialGuru : '<span class="text-gray-300 text-xs">...</span>'}
                        </div>
                    </div>

                    <select onchange="onGuruChange(this, '${cellId}')" class="w-full border border-gray-300 rounded p-0.5 bg-white text-[10px] mt-1 cursor-pointer">
                        ${options}
                    </select>
                </div>
            `;
        }

        function updateJadwalMemory(cellId, mapelId, guruId) {
            if(!jadwalFix[cellId]) jadwalFix[cellId] = {};
            jadwalFix[cellId].mapelId = mapelId;
            jadwalFix[cellId].guruId = guruId;
        }

        function hapusJadwal(cellId) {
            delete jadwalFix[cellId];
            const cell = document.getElementById(cellId);
            cell.innerHTML = '';
            cell.classList.remove('conflict');
        }

        function onGuruChange(selectEl, cellId) {
            const guruId = selectEl.value;
            const data = jadwalFix[cellId];
            
            // Simpan Guru
            data.guruId = guruId;
            
            // Render ulang cell agar Inisial Guru di tengah berubah sesuai pilihan
            renderCellContent(cellId, data.mapelId, guruId);

            // Cek Tabrakan
            const [hari, kelas, jam] = cellId.split('-');
            const result = validateMove(hari, kelas, jam, data.mapelId, guruId);
            const cell = document.getElementById(cellId);
            
            if(result.status) {
                alert(`TABRAKAN: ${result.msg}`);
                cell.classList.add('conflict');
            } else {
                cell.classList.remove('conflict');
            }
        }

        function checkAllConflicts(hari, kelas, jam, mapelId, guruId, cellId) {
            const res = validateMove(hari, kelas, jam, mapelId, guruId);
            const cell = document.getElementById(cellId);
            if(res.status) cell.classList.add('conflict');
            else cell.classList.remove('conflict');
        }

        // === VALIDASI LENGKAP (Sama seperti sebelumnya) ===
        function validateMove(day, currentClass, timeSlot, mapelId, guruId) {
            const currentMapelObj = mapelData.find(m => m.id == mapelId);
            const mapelName = currentMapelObj ? currentMapelObj.nama.toLowerCase() : "";
            const currentAngkatan = currentClass.charAt(0); 

            for (let otherClass of kelasList) {
                if (otherClass === currentClass) continue; 

                const otherKey = `${day}-${otherClass}-${timeSlot}`;
                const otherData = jadwalFix[otherKey];

                if (otherData) {
                    const otherMapelObj = mapelData.find(m => m.id == otherData.mapelId);
                    const otherMapelName = otherMapelObj ? otherMapelObj.nama.toLowerCase() : "";
                    const otherAngkatan = otherClass.charAt(0);

                    // 1. GURU (Global)
                    if (guruId && otherData.guruId && guruId == otherData.guruId) {
                        return { status: true, msg: `Guru yang sama sedang mengajar di kelas ${otherClass}.` };
                    }

                    // 2. LAB (Global)
                    const isRestricted = labSubjects.some(sub => mapelName.includes(sub));
                    if (isRestricted && otherMapelName === mapelName) {
                        return { status: true, msg: `Ruang Lab/Khusus dipakai ${otherClass}.` };
                    }

                    // 3. PJOK (Beda Angkatan = Tabrakan)
                    const isPjok = mapelName.includes('pjok') || mapelName.includes('olahraga');
                    const isOtherPjok = otherMapelName.includes('pjok') || otherMapelName.includes('olahraga');
                    if (isPjok && isOtherPjok) {
                        if (currentAngkatan !== otherAngkatan) {
                            return { status: true, msg: `Lapangan Penuh! PJOK Angkatan ${currentAngkatan} bentrok dengan ${otherAngkatan}.` };
                        }
                        continue; 
                    }

                    // 4. ANGKATAN (Mapel Sama = Tabrakan)
                    if (currentAngkatan === otherAngkatan) {
                        if (mapelName === otherMapelName) {
                            if (mapelName.includes('doa')) continue;
                            return { status: true, msg: `Kelas ${otherClass} (satu angkatan) sedang mapel sama.` };
                        }
                    }
                }
            }
            return { status: false, msg: "Aman" };
        }

        function simpanJadwalFix() {
            localStorage.setItem('jadwal_fix', JSON.stringify(jadwalFix));
            alert('Jadwal tersimpan.');
        }

        function resetJadwal() {
            if(confirm('Hapus semua?')) {
                localStorage.removeItem('jadwal_fix');
                location.reload();
            }
        }
    </script>
</body>
</html>
