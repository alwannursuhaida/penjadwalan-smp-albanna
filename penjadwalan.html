<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Susun Jadwal - EduSched</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .drag-over { background-color: #e0f2fe !important; border: 2px dashed #3b82f6; }
        .conflict { border: 2px solid red !important; background-color: #fee2e2 !important; }
        
        /* Sticky Header untuk Jam */
        .sticky-header th { position: sticky; top: 0; z-index: 10; background-color: #1f2937; color: white; }
        /* Sticky Column untuk Kelas */
        .sticky-col { position: sticky; left: 0; z-index: 10; background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <header class="bg-blue-900 text-white p-4 flex justify-between items-center shadow-md flex-shrink-0">
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-blue-200 hover:text-white"><i class="fas fa-arrow-left"></i> Dashboard</a>
            <h1 class="text-xl font-bold border-l border-blue-700 pl-4">Penyusunan Jadwal Kelas</h1>
        </div>
        <div class="flex gap-3 items-center">
            <label class="font-semibold text-sm">Lihat Hari:</label>
            <select id="select-hari" onchange="renderJadwalView()" class="text-gray-800 rounded p-1 text-sm font-bold">
                <option value="senin">Senin</option>
                <option value="selasa">Selasa</option>
                <option value="rabu">Rabu</option>
                <option value="kamis">Kamis</option>
                <option value="jumat">Jumat</option>
            </select>
            
            <button onclick="simpanJadwalFix()" class="bg-green-500 hover:bg-green-600 px-4 py-1 rounded text-sm font-bold shadow ml-4">
                <i class="fas fa-save mr-1"></i> Simpan
            </button>
            <button onclick="resetJadwal()" class="bg-red-500 hover:bg-red-600 px-4 py-1 rounded text-sm font-bold shadow">
                <i class="fas fa-trash"></i> Reset
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col shadow-lg z-20">
            <div class="p-4 border-b bg-gray-50">
                <h3 class="font-bold text-gray-700"><i class="fas fa-book mr-2"></i>Mapel</h3>
                <p class="text-xs text-gray-500">Drag mapel ke tabel.</p>
            </div>
            <div id="source-container" class="flex-1 overflow-y-auto p-3 space-y-2">
                </div>
            <div class="p-3 border-t bg-yellow-50 text-xs text-yellow-800">
                <i class="fas fa-exclamation-triangle mr-1"></i> 
                <b>Aturan Tabrakan:</b><br>
                1. Guru (Global)<br>
                2. Angkatan (Kecuali PJOK)<br>
                3. Lab (Info, IPA, Seni, B.Bali)
            </div>
        </aside>

        <main class="flex-1 overflow-auto bg-gray-100 p-4 relative">
            <div class="bg-white rounded shadow border border-gray-300 inline-block min-w-full">
                <table class="w-full border-collapse text-sm">
                    <thead class="sticky-header">
                        <tr id="header-row">
                            <th class="p-3 border w-24 z-20 sticky-col text-left pl-4">KELAS</th>
                            </tr>
                    </thead>
                    <tbody id="jadwal-body">
                        </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        // === DATA STORE ===
        const kelasList = [
            '7A', '7B', '7C', '7D', '7E', '7F',
            '8A', '8B', '8C', '8D', '8E', '8F',
            '9A', '9B', '9C', '9D', '9E'
        ];
        
        // Mapel Khusus (Lab/Ruang Khusus) - Validasi Lintas Angkatan
        const labSubjects = ['informatika', 'ipa', 'seni budaya', 'bahasa bali'];
        
        let mapelData = [];
        let guruData = [];
        let settingData = {};
        // Struktur Jadwal: { "senin-7A-1": {mapelId: x, guruId: y}, ... }
        let jadwalFix = {}; 

        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            renderSourceMapel();
            renderJadwalView();
        });

        function loadAllData() {
            mapelData = JSON.parse(localStorage.getItem('jadwal_mapel')) || [];
            guruData = JSON.parse(localStorage.getItem('jadwal_guru')) || [];
            settingData = JSON.parse(localStorage.getItem('jadwal_pengaturan')) || { slots: [] };
            jadwalFix = JSON.parse(localStorage.getItem('jadwal_fix')) || {};

            // Validasi jika data kosong
            if(settingData.slots.length === 0) {
                alert("Silakan atur Jam Pelajaran dulu di menu Pengaturan Waktu!");
                window.location.href = 'pengaturan-waktu.html';
            }
        }

        // --- RENDER SIDEBAR MAPEL ---
        function renderSourceMapel() {
            const container = document.getElementById('source-container');
            container.innerHTML = '';
            
            mapelData.forEach(m => {
                const div = document.createElement('div');
                div.className = "p-3 rounded shadow-sm border cursor-move text-white font-medium text-sm flex justify-between items-center hover:scale-105 transition transform";
                div.style.backgroundColor = m.warna;
                div.innerText = m.nama;
                
                div.setAttribute('draggable', 'true');
                div.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify(m));
                });
                container.appendChild(div);
            });
        }

        // --- RENDER UTAMA (VIEW PER HARI) ---
        function renderJadwalView() {
            const hari = document.getElementById('select-hari').value;
            const headerRow = document.getElementById('header-row');
            const tbody = document.getElementById('jadwal-body');

            // 1. Render Header (Jam Pelajaran)
            headerRow.innerHTML = `<th class="p-3 border w-24 z-20 sticky-col bg-gray-800 text-white">KELAS</th>`;
            settingData.slots.forEach(slot => {
                const isIstirahat = slot.type === 'istirahat';
                const bg = isIstirahat ? 'bg-orange-600' : 'bg-gray-800';
                headerRow.innerHTML += `
                    <th class="p-2 border text-center w-32 ${bg} text-white">
                        <div class="text-xs font-light">${slot.start} - ${slot.end}</div>
                        <div>JP ${slot.no}</div>
                    </th>
                `;
            });

            // 2. Render Rows (Kelas 7A - 9E)
            tbody.innerHTML = '';
            kelasList.forEach(kelas => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";

                // Kolom Nama Kelas (Sticky Kiri)
                const angkatan = kelas.substring(0, 1); // 7, 8, atau 9
                let colorClass = 'bg-blue-100 text-blue-800';
                if(angkatan === '8') colorClass = 'bg-green-100 text-green-800';
                if(angkatan === '9') colorClass = 'bg-purple-100 text-purple-800';

                tr.innerHTML = `<td class="p-3 border font-bold text-center sticky-col ${colorClass}">${kelas}</td>`;

                // Kolom Jam
                settingData.slots.forEach(slot => {
                    if (slot.type === 'istirahat') {
                        tr.innerHTML += `<td class="border bg-orange-100 text-center text-xs text-orange-400 font-bold slant">ISTIRAHAT</td>`;
                    } else {
                        // Key Unik: hari-kelas-jam
                        const cellId = `${hari}-${kelas}-${slot.no}`;
                        
                        tr.innerHTML += `
                            <td id="${cellId}" class="border p-1 relative h-20 align-top transition hover:bg-blue-50"
                                ondragover="allowDrop(event)" 
                                ondragleave="leaveDrop(event)" 
                                ondrop="drop(event, '${hari}', '${kelas}', '${slot.no}')">
                            </td>
                        `;
                    }
                });
                tbody.appendChild(tr);
            });

            // 3. Isi Data (Hydrate Cells)
            hydrateCells(hari);
        }

        function hydrateCells(hari) {
            kelasList.forEach(kelas => {
                settingData.slots.forEach(slot => {
                    if (slot.type !== 'istirahat') {
                        const cellId = `${hari}-${kelas}-${slot.no}`;
                        const data = jadwalFix[cellId];
                        if (data) {
                            renderCellContent(cellId, data.mapelId, data.guruId);
                            // Cek tabrakan lagi (visual validation)
                            checkAllConflicts(hari, kelas, slot.no, data.mapelId, data.guruId, cellId);
                        }
                    }
                });
            });
        }

        // --- DRAG & DROP LOGIC ---
        function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function leaveDrop(e) { e.currentTarget.classList.remove('drag-over'); }

        function drop(e, hari, kelas, jam) {
            e.preventDefault();
            const cell = e.currentTarget;
            cell.classList.remove('drag-over');
            
            const raw = e.dataTransfer.getData('text/plain');
            if(!raw) return;
            const mapel = JSON.parse(raw);

            // Simpan ke state sementara (guru masih kosong)
            const cellId = cell.id;
            
            // Render dulu
            renderCellContent(cellId, mapel.id, null);
            
            // Simpan ke memory
            updateJadwalMemory(cellId, mapel.id, null);

            // Validasi Awal (Level Mapel)
            const conflict = validateMove(hari, kelas, jam, mapel.id, null);
            if(conflict.status) {
                alert(`PERINGATAN: ${conflict.msg}`);
                cell.classList.add('conflict');
            } else {
                cell.classList.remove('conflict');
            }
        }

        // --- RENDER ISI KOTAK ---
        function renderCellContent(cellId, mapelId, currentGuruId) {
            const cell = document.getElementById(cellId);
            const mapel = mapelData.find(m => m.id == mapelId);
            if(!mapel) return;

            // Buat opsi guru
            let options = `<option value="">Pilih Guru...</option>`;
            guruData.forEach(g => {
                const sel = (g.id == currentGuruId) ? 'selected' : '';
                options += `<option value="${g.id}" ${sel}>${g.kode} - ${g.nama}</option>`;
            });

            cell.innerHTML = `
                <div class="h-full w-full rounded p-1 text-xs shadow-sm flex flex-col justify-between" 
                     style="background-color: ${mapel.warna}20; border-left: 3px solid ${mapel.warna};">
                    <div class="flex justify-between items-start">
                        <span class="font-bold text-gray-800 truncate" title="${mapel.nama}">${mapel.nama}</span>
                        <button onclick="hapusJadwal('${cellId}')" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
                    </div>
                    <select onchange="onGuruChange(this, '${cellId}')" class="w-full mt-1 border border-gray-300 rounded text-xs p-1 bg-white">
                        ${options}
                    </select>
                </div>
            `;
        }

        function updateJadwalMemory(cellId, mapelId, guruId) {
            if(!jadwalFix[cellId]) jadwalFix[cellId] = {};
            jadwalFix[cellId].mapelId = mapelId;
            jadwalFix[cellId].guruId = guruId;
        }

        function hapusJadwal(cellId) {
            delete jadwalFix[cellId];
            document.getElementById(cellId).innerHTML = '';
            document.getElementById(cellId).classList.remove('conflict');
        }

        // --- VALIDATION CORE (THE LOGIC) ---
        function onGuruChange(selectEl, cellId) {
            const guruId = selectEl.value;
            const data = jadwalFix[cellId];
            data.guruId = guruId; // Update guru

            // Parse ID untuk dapat konteks
            const [hari, kelas, jam] = cellId.split('-');
            
            // Validasi Full
            const result = validateMove(hari, kelas, jam, data.mapelId, guruId);
            const cell = document.getElementById(cellId);
            
            if(result.status) {
                alert(`TABRAKAN TERDETEKSI:\n${result.msg}`);
                cell.classList.add('conflict');
                selectEl.classList.add('bg-red-100');
            } else {
                cell.classList.remove('conflict');
                selectEl.classList.remove('bg-red-100');
                // Kita juga perlu cek ulang 'korban' lain jika konflik selesai (tapi ini advance, skip dulu)
            }
        }

        function checkAllConflicts(hari, kelas, jam, mapelId, guruId, cellId) {
            const res = validateMove(hari, kelas, jam, mapelId, guruId);
            const cell = document.getElementById(cellId);
            if(res.status) cell.classList.add('conflict');
            else cell.classList.remove('conflict');
        }

        function validateMove(day, currentClass, timeSlot, mapelId, guruId) {
            const currentMapelObj = mapelData.find(m => m.id == mapelId);
            const mapelName = currentMapelObj ? currentMapelObj.nama.toLowerCase() : "";
            const currentAngkatan = currentClass.charAt(0); // 7, 8, atau 9

            // Loop seluruh kelas lain di jam yang sama
            for (let otherClass of kelasList) {
                if (otherClass === currentClass) continue; // Skip diri sendiri

                const otherKey = `${day}-${otherClass}-${timeSlot}`;
                const otherData = jadwalFix[otherKey];

                if (otherData) {
                    const otherMapelObj = mapelData.find(m => m.id == otherData.mapelId);
                    const otherMapelName = otherMapelObj ? otherMapelObj.nama.toLowerCase() : "";

                    // ATURAN 1: GURU TIDAK BOLEH TABRAKAN
                    // Cek jika guru sudah dipilih (tidak null) dan sama
                    if (guruId && otherData.guruId && guruId == otherData.guruId) {
                        return { status: true, msg: `Guru ini sedang mengajar di kelas ${otherClass} pada jam yang sama.` };
                    }

                    // ATURAN 2: MAPEL LAB (Informatika, IPA, Seni, B.Bali) TIDAK BOLEH TABRAKAN DI SELURUH ANGKATAN
                    // Cek apakah mapel ini termasuk restricted
                    const isRestricted = labSubjects.some(sub => mapelName.includes(sub));
                    if (isRestricted && otherMapelName === mapelName) {
                        return { status: true, msg: `Mapel '${currentMapelObj.nama}' (Lab/Khusus) sedang dipakai kelas ${otherClass}. Tidak boleh bersamaan.` };
                    }

                    // ATURAN 3: ANGKATAN TIDAK BOLEH TABRAKAN MAPEL (Kecuali PJOK)
                    // Cek jika kelas lain adalah satu angkatan (misal 7A vs 7B)
                    if (otherClass.startsWith(currentAngkatan)) {
                        // Jika mapel sama
                        if (mapelName === otherMapelName) {
                            // Kecuali PJOK
                            if (!mapelName.includes('pjok') && !mapelName.includes('olahraga')) {
                                return { status: true, msg: `Kelas ${otherClass} (Satu Angkatan) sedang belajar ${currentMapelObj.nama}. Harus beda mapel.` };
                            }
                        }
                    }
                }
            }

            return { status: false, msg: "Aman" };
        }

        function simpanJadwalFix() {
            localStorage.setItem('jadwal_fix', JSON.stringify(jadwalFix));
            alert('Jadwal berhasil disimpan!');
        }

        function resetJadwal() {
            if(confirm('Hapus semua jadwal?')) {
                localStorage.removeItem('jadwal_fix');
                location.reload();
            }
        }
    </script>
</body>
</html>
